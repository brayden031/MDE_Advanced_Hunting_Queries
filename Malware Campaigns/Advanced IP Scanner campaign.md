# Advanced IP Scanner campaign
These advanced hunts are based off the report released by Huntress regarding a new malicious "Advanced IP Scanner campaign". The report these hunts are based off can be found at - https://www.linkedin.com/posts/activity-7196663164468416512-2z9B?utm_source=share&utm_medium=member_desktop

## Hunting endpoints for domain connections and malicious exectuables in the Windows NT subdirectory:

```KQL
let suspiciousfiles = pack_array(
"setup164.exe",
"1644.exe",
"UniversalInstaller.exe",
"relay.dll"
);
search in (DeviceNetworkEvents, DeviceProcessEvents, DeviceFileEvents, DeviceEvents)
Timestamp between (ago(30d) .. now())
and (
RemoteUrl contains @"adlvanced-ip-scanner.com"
or FileOriginUrl contains @"adlvanced-ip-scanner.com"
or FileOriginReferrerUrl contains @"adlvanced-ip-scanner.com"
or FileName in (suspiciousfiles)
or InitiatingProcessFileName in (suspiciousfiles)
or InitiatingProcessCommandLine in (suspiciousfiles)
or ProcessCommandLine in (suspiciousfiles)
or FolderPath endswith @"setup164.exe"
or FolderPath endswith @"1644.exe"
or FolderPath endswith @"UniversalInstaller.exe"
or FolderPath endswith @"relay.dll"
or InitiatingProcessFolderPath endswith @"setup164.exe"
or InitiatingProcessFolderPath endswith @"1644.exe"
or InitiatingProcessFolderPath endswith @"UniversalInstaller.exe"
or InitiatingProcessFolderPath endswith @"relay.dll"
)
| project Timestamp, DeviceId, DeviceName, ProcessCommandLine, FileName, InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessFolderPath, InitiatingProcessParentFileName, MD5
| limit 10
```

## Hunt for any other potentially malicious executables stored in the windows NT subdirectory:

```KQL
search in (DeviceNetworkEvents, DeviceProcessEvents, DeviceFileEvents, DeviceEvents)
Timestamp between (ago(30d) .. now())
and (
FolderPath contains @"\Program Files\Windows NT\"
and FolderPath endswith ".exe"
)
| project Timestamp, DeviceId, DeviceName, ProcessCommandLine, FileName, InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessFolderPath, InitiatingProcessParentFileName, MD5
// allowlisting
| where FileName != "wordpad.exe"
and FileName != "wordpad.exe.mui"
```
